"""recRBAC

Revision ID: 2f89cbe0b126
Revises: 8d2e59e4334d
Create Date: 2025-12-25 17:56:53.872452

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

# revision identifiers, used by Alembic.
revision: str = '2f89cbe0b126'
down_revision: Union[str, Sequence[str], None] = '8d2e59e4334d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('permission',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='权限ID'),
    sa.Column('permission_code', sa.String(length=64), nullable=False, comment='权限编码'),
    sa.Column('permission_name', sa.String(length=128), nullable=False, comment='权限名称'),
    sa.Column('permission_type', sa.Integer(), nullable=False, comment='权限类型 1-查看 2-操作 3-导出 4-配置'),
    sa.Column('permission_description', sa.String(length=256), nullable=True, comment='权限描述'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('permission_code')
    )
    op.create_table('role',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='角色ID'),
    sa.Column('role_code', sa.String(length=64), nullable=False, comment='角色编码'),
    sa.Column('role_name', sa.String(length=128), nullable=False, comment='角色名称'),
    sa.Column('description', sa.String(length=256), nullable=True, comment='角色描述'),
    sa.Column('status', sa.Integer(), nullable=True, comment='状态 1-启用 0-禁用'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('role_code')
    )
    op.create_table('role_permission',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('role_id', sa.BigInteger(), nullable=False),
    sa.Column('permission_id', sa.BigInteger(), nullable=False),
    sa.Column('create_time', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['permission_id'], ['permission.id'], ),
    sa.ForeignKeyConstraint(['role_id'], ['role.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('role_id', 'permission_id', name='uk_role_permission')
    )
    op.create_table('user_role',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('role_id', sa.BigInteger(), nullable=False),
    sa.Column('create_time', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['role_id'], ['role.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'role_id', name='uk_user_role')
    )
    op.drop_table('user_permission')
    op.drop_index('permission_code', table_name='permission_dict')
    op.drop_table('permission_dict')
    op.add_column('user', sa.Column('user_id', sa.String(length=32), nullable=False, comment='工号/账号'))
    op.add_column('user', sa.Column('status', sa.Integer(), nullable=True, comment='状态 1-启用 0-禁用'))
    op.add_column('user', sa.Column('wx_session_key', sa.String(length=64), nullable=True, comment='用户session_key'))
    op.add_column('user', sa.Column('token', sa.String(length=64), nullable=True, comment='用户token'))
    op.add_column('user', sa.Column('refresh_token', sa.String(length=64), nullable=True, comment='用户refresh_token'))
    op.add_column('user', sa.Column('last_login_ip', sa.String(length=64), nullable=True, comment='最近登录IP'))
    op.add_column('user', sa.Column('nnlg_key', sa.String(length=128), nullable=True, comment='用户nnlg_key'))
    op.alter_column('user', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除',
               existing_comment='逻辑删除 0-正常 1-删除',
               existing_nullable=True)
    op.drop_index('user_no', table_name='user')
    op.create_unique_constraint(None, 'user', ['user_id'])
    op.drop_column('user', 'role_type')
    op.drop_column('user', 'user_no')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('user', sa.Column('user_no', mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=32), nullable=False, comment='工号/账号'))
    op.add_column('user', sa.Column('role_type', mysql.INTEGER(), autoincrement=False, nullable=False, comment='角色类型 1-普通教师 2-督导 3-学院管理员 4-学校管理员'))
    op.drop_constraint(None, 'user', type_='unique')
    op.create_index('user_no', 'user', ['user_no'], unique=False)
    op.alter_column('user', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除 0-正常 1-删除',
               existing_comment='逻辑删除',
               existing_nullable=True)
    op.drop_column('user', 'nnlg_key')
    op.drop_column('user', 'last_login_ip')
    op.drop_column('user', 'refresh_token')
    op.drop_column('user', 'token')
    op.drop_column('user', 'wx_session_key')
    op.drop_column('user', 'status')
    op.drop_column('user', 'user_id')
    op.create_table('permission_dict',
    sa.Column('id', mysql.BIGINT(), autoincrement=True, nullable=False, comment='权限ID'),
    sa.Column('permission_code', mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64), nullable=False, comment='权限编码（唯一）'),
    sa.Column('permission_name', mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=128), nullable=False, comment='权限名称'),
    sa.Column('permission_type', mysql.INTEGER(), autoincrement=False, nullable=False, comment='权限类型 1-数据查看 2-操作管理 3-报表导出 4-系统配置'),
    sa.Column('parent_id', mysql.BIGINT(), autoincrement=False, nullable=True, comment='父权限ID（0=顶级权限）'),
    sa.Column('sort', mysql.INTEGER(), autoincrement=False, nullable=True, comment='排序值'),
    sa.Column('create_time', mysql.DATETIME(), nullable=True, comment='创建时间'),
    sa.Column('is_delete', mysql.TINYINT(display_width=1), autoincrement=False, nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.PrimaryKeyConstraint('id'),
    mysql_collate='utf8mb4_unicode_ci',
    mysql_default_charset='utf8mb4',
    mysql_engine='InnoDB'
    )
    op.create_index('permission_code', 'permission_dict', ['permission_code'], unique=False)
    op.create_table('user_permission',
    sa.Column('id', mysql.BIGINT(), autoincrement=True, nullable=False, comment='关联ID'),
    sa.Column('user_id', mysql.BIGINT(), autoincrement=False, nullable=False, comment='用户ID'),
    sa.Column('permission_id', mysql.BIGINT(), autoincrement=False, nullable=False, comment='权限ID（关联permission_dict）'),
    sa.Column('scope_college_ids', mysql.JSON(), nullable=True, comment='权限生效范围（如["1","2"]=仅1/2学院生效）'),
    sa.Column('create_time', mysql.DATETIME(), nullable=True, comment='绑定时间'),
    sa.Column('operator_id', mysql.BIGINT(), autoincrement=False, nullable=False, comment='授权人ID（学校管理员）'),
    sa.Column('is_delete', mysql.TINYINT(display_width=1), autoincrement=False, nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.ForeignKeyConstraint(['operator_id'], ['user.id'], name='user_permission_ibfk_1'),
    sa.ForeignKeyConstraint(['permission_id'], ['permission_dict.id'], name='user_permission_ibfk_2'),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], name='user_permission_ibfk_3'),
    sa.PrimaryKeyConstraint('id'),
    mysql_collate='utf8mb4_unicode_ci',
    mysql_default_charset='utf8mb4',
    mysql_engine='InnoDB'
    )
    op.drop_table('user_role')
    op.drop_table('role_permission')
    op.drop_table('role')
    op.drop_table('permission')
    # ### end Alembic commands ###
