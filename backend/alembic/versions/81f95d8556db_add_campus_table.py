"""add campus table

Revision ID: 81f95d8556db
Revises: 0aa283a71cd1
Create Date: 2026-01-04 23:22:08.025984

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

# revision identifiers, used by Alembic.
revision: str = '81f95d8556db'
down_revision: Union[str, Sequence[str], None] = '0aa283a71cd1'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    # 检查表是否已存在，如果不存在则创建
    from sqlalchemy import inspect
    bind = op.get_bind()
    inspector = inspect(bind)
    existing_tables = inspector.get_table_names()
    
    if 'campus' not in existing_tables:
        op.create_table('campus',
        sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='校区ID'),
        sa.Column('campus_name', sa.String(length=64), nullable=False, comment='校区名称'),
        sa.Column('sort_order', sa.SmallInteger(), nullable=True, comment='排序'),
        sa.Column('create_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True, comment='创建时间'),
        sa.Column('update_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True, comment='更新时间'),
        sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('campus_name'),
        comment='校区表',
        mysql_charset='utf8mb4',
        mysql_collate='utf8mb4_unicode_ci'
        )
        op.create_index('idx_campus_delete', 'campus', ['is_delete'], unique=False)
        op.create_index(op.f('ix_campus_is_delete'), 'campus', ['is_delete'], unique=False)
    
    # 先修改 campus_id 列类型为 BIGINT，与 campus.id 类型一致
    op.alter_column('college', 'campus_id',
               existing_type=mysql.TINYINT(),
               type_=sa.BigInteger(),
               comment='校区ID',
               existing_comment='校区ID（1-南宁 2-桂林，可空）',
               existing_nullable=True)
    op.create_foreign_key('fk_college_campus', 'college', 'campus', ['campus_id'], ['id'], ondelete='SET NULL')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint('fk_college_campus', 'college', type_='foreignkey')
    op.alter_column('college', 'campus_id',
               existing_type=sa.BigInteger(),
               type_=mysql.TINYINT(),
               comment='校区ID（1-南宁 2-桂林，可空）',
               existing_comment='校区ID',
               existing_nullable=True)
    op.drop_index(op.f('ix_campus_is_delete'), table_name='campus')
    op.drop_index('idx_campus_delete', table_name='campus')
    op.drop_table('campus')
    # ### end Alembic commands ###
