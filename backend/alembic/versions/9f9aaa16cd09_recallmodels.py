"""recAllModels

Revision ID: 9f9aaa16cd09
Revises: 2f89cbe0b126
Create Date: 2025-12-25 19:12:38.529087

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

# revision identifiers, used by Alembic.
revision: str = '9f9aaa16cd09'
down_revision: Union[str, Sequence[str], None] = '2f89cbe0b126'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('evaluation_dimension',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('dimension_code', sa.String(length=32), nullable=False, comment='维度编码'),
    sa.Column('dimension_name', sa.String(length=64), nullable=False, comment='维度名称'),
    sa.Column('max_score', mysql.TINYINT(), nullable=False, comment='该维度最高分'),
    sa.Column('weight', sa.DECIMAL(precision=3, scale=2), nullable=False, comment='权重'),
    sa.Column('sort_order', sa.SmallInteger(), nullable=True, comment='排序'),
    sa.Column('description', sa.String(length=256), nullable=True, comment='维度说明'),
    sa.Column('scoring_criteria', sa.JSON(), nullable=True, comment='评分标准说明'),
    sa.Column('is_required', sa.Boolean(), nullable=True, comment='是否必填'),
    sa.Column('status', mysql.TINYINT(), nullable=True, comment='状态 1-启用 0-禁用'),
    sa.Column('create_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('update_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('is_delete', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    comment='评价维度配置表',
    mysql_charset='utf8mb4',
    mysql_collate='utf8mb4_unicode_ci'
    )
    op.create_index('idx_dimension_status_order', 'evaluation_dimension', ['status', 'sort_order'], unique=False)
    op.create_index(op.f('ix_evaluation_dimension_dimension_code'), 'evaluation_dimension', ['dimension_code'], unique=True)
    op.create_index(op.f('ix_evaluation_dimension_is_delete'), 'evaluation_dimension', ['is_delete'], unique=False)
    op.create_table('login_log_archive',
    sa.Column('id', sa.BigInteger(), nullable=False, comment='原日志ID'),
    sa.Column('user_id', sa.BigInteger(), nullable=True, comment='用户ID'),
    sa.Column('user_name', sa.String(length=64), nullable=True, comment='用户名'),
    sa.Column('login_type', sa.String(length=16), nullable=False, comment='登录类型'),
    sa.Column('login_status', mysql.TINYINT(), nullable=False, comment='登录状态'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP地址'),
    sa.Column('location', sa.String(length=64), nullable=True, comment='登录地点'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='登录时间'),
    sa.Column('create_date', sa.String(length=10), nullable=True, comment='创建日期'),
    sa.Column('archive_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True, comment='归档时间'),
    sa.PrimaryKeyConstraint('id'),
    comment='登录日志归档表',
    mysql_charset='utf8mb4',
    mysql_collate='utf8mb4_unicode_ci'
    )
    op.create_index('idx_login_archive_date', 'login_log_archive', ['create_date'], unique=False)
    op.create_index(op.f('ix_login_log_archive_create_date'), 'login_log_archive', ['create_date'], unique=False)
    op.create_index(op.f('ix_login_log_archive_create_time'), 'login_log_archive', ['create_time'], unique=False)
    op.create_table('operation_log_archive',
    sa.Column('id', sa.BigInteger(), nullable=False, comment='原日志ID'),
    sa.Column('user_id', sa.BigInteger(), nullable=True, comment='操作用户ID'),
    sa.Column('user_name', sa.String(length=64), nullable=True, comment='操作用户名'),
    sa.Column('operation_type', sa.String(length=32), nullable=False, comment='操作类型'),
    sa.Column('module', sa.String(length=32), nullable=False, comment='模块'),
    sa.Column('target_id', sa.BigInteger(), nullable=True, comment='操作目标ID'),
    sa.Column('target_type', sa.String(length=32), nullable=True, comment='操作目标类型'),
    sa.Column('content', sa.JSON(), nullable=True, comment='操作详情'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP地址'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('create_date', sa.String(length=10), nullable=True, comment='创建日期'),
    sa.Column('archive_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True, comment='归档时间'),
    sa.PrimaryKeyConstraint('id'),
    comment='操作日志归档表',
    mysql_charset='utf8mb4',
    mysql_collate='utf8mb4_unicode_ci'
    )
    op.create_index('idx_archive_date', 'operation_log_archive', ['create_date'], unique=False)
    op.create_index('idx_archive_user', 'operation_log_archive', ['user_id', 'create_time'], unique=False)
    op.create_index(op.f('ix_operation_log_archive_create_date'), 'operation_log_archive', ['create_date'], unique=False)
    op.create_index(op.f('ix_operation_log_archive_create_time'), 'operation_log_archive', ['create_time'], unique=False)
    op.create_table('login_log',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('user_name', sa.String(length=64), nullable=True, comment='用户名/工号'),
    sa.Column('login_type', sa.String(length=16), nullable=False, comment='登录类型（PASSWORD/WECHAT/TOKEN）'),
    sa.Column('login_status', mysql.TINYINT(), nullable=False, comment='登录状态 1-成功 0-失败'),
    sa.Column('fail_reason', sa.String(length=128), nullable=True, comment='失败原因'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP地址'),
    sa.Column('location', sa.String(length=64), nullable=True, comment='登录地点'),
    sa.Column('device_type', sa.String(length=32), nullable=True, comment='设备类型（PC/MOBILE/TABLET）'),
    sa.Column('browser', sa.String(length=64), nullable=True, comment='浏览器'),
    sa.Column('os', sa.String(length=64), nullable=True, comment='操作系统'),
    sa.Column('user_agent', sa.String(length=512), nullable=True, comment='User-Agent'),
    sa.Column('create_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True, comment='登录时间'),
    sa.Column('create_date', sa.String(length=10), nullable=False, comment='创建日期(YYYY-MM-DD)'),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='登录日志表',
    mysql_charset='utf8mb4',
    mysql_collate='utf8mb4_unicode_ci'
    )
    op.create_index('idx_login_date', 'login_log', ['create_date'], unique=False)
    op.create_index('idx_login_status_time', 'login_log', ['login_status', 'create_time'], unique=False)
    op.create_index('idx_login_user_time', 'login_log', ['user_id', 'create_time'], unique=False)
    op.create_index(op.f('ix_login_log_create_date'), 'login_log', ['create_date'], unique=False)
    op.create_index(op.f('ix_login_log_create_time'), 'login_log', ['create_time'], unique=False)
    op.create_index(op.f('ix_login_log_user_id'), 'login_log', ['user_id'], unique=False)
    op.create_table('operation_log',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True, comment='操作用户ID'),
    sa.Column('user_name', sa.String(length=64), nullable=True, comment='操作用户名（冗余，防止用户删除后丢失）'),
    sa.Column('operation_type', sa.String(length=32), nullable=False, comment='操作类型'),
    sa.Column('module', sa.String(length=32), nullable=False, comment='模块'),
    sa.Column('target_id', sa.BigInteger(), nullable=True, comment='操作目标ID'),
    sa.Column('target_type', sa.String(length=32), nullable=True, comment='操作目标类型'),
    sa.Column('content', sa.JSON(), nullable=True, comment='操作详情'),
    sa.Column('before_data', sa.JSON(), nullable=True, comment='操作前数据'),
    sa.Column('after_data', sa.JSON(), nullable=True, comment='操作后数据'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP地址'),
    sa.Column('user_agent', sa.String(length=512), nullable=True, comment='User-Agent'),
    sa.Column('request_url', sa.String(length=256), nullable=True, comment='请求URL'),
    sa.Column('request_method', sa.String(length=10), nullable=True, comment='请求方法'),
    sa.Column('response_code', sa.SmallInteger(), nullable=True, comment='响应状态码'),
    sa.Column('execute_time', sa.SmallInteger(), nullable=True, comment='执行耗时(ms)'),
    sa.Column('create_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True, comment='创建时间'),
    sa.Column('create_date', sa.String(length=10), nullable=False, comment='创建日期(YYYY-MM-DD)，用于分区和归档'),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    comment='操作日志表',
    mysql_charset='utf8mb4',
    mysql_collate='utf8mb4_unicode_ci'
    )
    op.create_index('idx_log_date', 'operation_log', ['create_date'], unique=False)
    op.create_index('idx_log_module_type', 'operation_log', ['module', 'operation_type'], unique=False)
    op.create_index('idx_log_target', 'operation_log', ['target_type', 'target_id'], unique=False)
    op.create_index('idx_log_user_time', 'operation_log', ['user_id', 'create_time'], unique=False)
    op.create_index(op.f('ix_operation_log_create_date'), 'operation_log', ['create_date'], unique=False)
    op.create_index(op.f('ix_operation_log_create_time'), 'operation_log', ['create_time'], unique=False)
    op.create_index(op.f('ix_operation_log_module'), 'operation_log', ['module'], unique=False)
    op.create_index(op.f('ix_operation_log_operation_type'), 'operation_log', ['operation_type'], unique=False)
    op.create_index(op.f('ix_operation_log_user_id'), 'operation_log', ['user_id'], unique=False)
    op.create_table('user_wechat_bind',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False, comment='用户ID'),
    sa.Column('openid', sa.String(length=64), nullable=False, comment='微信openid'),
    sa.Column('unionid', sa.String(length=64), nullable=True, comment='微信unionid'),
    sa.Column('session_key', sa.String(length=64), nullable=True, comment='session_key'),
    sa.Column('nickname', sa.String(length=64), nullable=True, comment='微信昵称'),
    sa.Column('avatar_url', sa.String(length=512), nullable=True, comment='微信头像'),
    sa.Column('bind_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True, comment='绑定时间'),
    sa.Column('update_time', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id'),
    comment='用户微信绑定表',
    mysql_charset='utf8mb4',
    mysql_collate='utf8mb4_unicode_ci'
    )
    op.create_index(op.f('ix_user_wechat_bind_openid'), 'user_wechat_bind', ['openid'], unique=True)
    op.create_index(op.f('ix_user_wechat_bind_unionid'), 'user_wechat_bind', ['unionid'], unique=True)
    op.add_column('college', sa.Column('short_name', sa.String(length=16), nullable=True, comment='学院简称'))
    op.add_column('college', sa.Column('sort_order', sa.SmallInteger(), nullable=True, comment='排序'))
    op.alter_column('college', 'college_code',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=32),
               comment='学院编码',
               existing_comment='学院编码（如01：信息工程学院）',
               existing_nullable=False)
    op.alter_column('college', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除',
               existing_comment='逻辑删除 0-正常 1-删除',
               existing_nullable=True)
    op.drop_index('college_code', table_name='college')
    op.create_index(op.f('ix_college_college_code'), 'college', ['college_code'], unique=True)
    op.create_index(op.f('ix_college_is_delete'), 'college', ['is_delete'], unique=False)
    op.create_table_comment(
        'college',
        '学院表',
        existing_comment=None,
        schema=None
    )
    op.add_column('college_evaluation_stat', sa.Column('total_evaluation_num', sa.SmallInteger(), nullable=True, comment='评价总次数'))
    op.add_column('college_evaluation_stat', sa.Column('school_total', sa.SmallInteger(), nullable=True, comment='参评学院总数'))
    op.add_column('college_evaluation_stat', sa.Column('score_distribution', sa.JSON(), nullable=True, comment='分数分布'))
    op.add_column('college_evaluation_stat', sa.Column('excellent_rate', sa.DECIMAL(precision=5, scale=2), nullable=True, comment='优秀率'))
    op.add_column('college_evaluation_stat', sa.Column('last_export_time', sa.DateTime(), nullable=True, comment='最后导出时间'))
    op.alter_column('college_evaluation_stat', 'stat_year',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=4),
               comment='统计学年',
               existing_comment='统计年份',
               existing_nullable=False)
    op.create_index('idx_college_stat_year_semester', 'college_evaluation_stat', ['stat_year', 'stat_semester'], unique=False)
    op.create_index(op.f('ix_college_evaluation_stat_college_id'), 'college_evaluation_stat', ['college_id'], unique=False)
    op.create_index(op.f('ix_college_evaluation_stat_stat_year'), 'college_evaluation_stat', ['stat_year'], unique=False)
    op.create_unique_constraint('uk_college_stat_period', 'college_evaluation_stat', ['college_id', 'stat_year', 'stat_semester'])
    op.drop_constraint('college_evaluation_stat_ibfk_1', 'college_evaluation_stat', type_='foreignkey')
    op.create_foreign_key(None, 'college_evaluation_stat', 'college', ['college_id'], ['id'], ondelete='CASCADE')
    op.create_table_comment(
        'college_evaluation_stat',
        '学院评价统计表',
        existing_comment=None,
        schema=None
    )
    op.add_column('permission', sa.Column('parent_id', sa.BigInteger(), nullable=True, comment='父权限ID'))
    op.add_column('permission', sa.Column('sort_order', sa.SmallInteger(), nullable=True, comment='排序'))
    op.drop_index('permission_code', table_name='permission')
    op.create_index('idx_permission_type_order', 'permission', ['permission_type', 'sort_order'], unique=False)
    op.create_index(op.f('ix_permission_is_delete'), 'permission', ['is_delete'], unique=False)
    op.create_index(op.f('ix_permission_parent_id'), 'permission', ['parent_id'], unique=False)
    op.create_index(op.f('ix_permission_permission_code'), 'permission', ['permission_code'], unique=True)
    op.create_index(op.f('ix_permission_permission_type'), 'permission', ['permission_type'], unique=False)
    op.create_foreign_key(None, 'permission', 'permission', ['parent_id'], ['id'], ondelete='CASCADE')
    op.create_table_comment(
        'permission',
        '权限表',
        existing_comment=None,
        schema=None
    )
    op.add_column('role', sa.Column('role_level', mysql.TINYINT(), nullable=True, comment='角色级别（用于权限继承）'))
    op.drop_index('role_code', table_name='role')
    op.create_index('idx_role_status_delete', 'role', ['status', 'is_delete'], unique=False)
    op.create_index(op.f('ix_role_is_delete'), 'role', ['is_delete'], unique=False)
    op.create_index(op.f('ix_role_role_code'), 'role', ['role_code'], unique=True)
    op.create_index(op.f('ix_role_status'), 'role', ['status'], unique=False)
    op.create_table_comment(
        'role',
        '角色表',
        existing_comment=None,
        schema=None
    )
    op.create_index(op.f('ix_role_permission_permission_id'), 'role_permission', ['permission_id'], unique=False)
    op.create_index(op.f('ix_role_permission_role_id'), 'role_permission', ['role_id'], unique=False)
    op.drop_constraint('role_permission_ibfk_1', 'role_permission', type_='foreignkey')
    op.drop_constraint('role_permission_ibfk_2', 'role_permission', type_='foreignkey')
    op.create_foreign_key(None, 'role_permission', 'permission', ['permission_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'role_permission', 'role', ['role_id'], ['id'], ondelete='CASCADE')
    op.create_table_comment(
        'role_permission',
        '角色权限关联表',
        existing_comment=None,
        schema=None
    )
    op.add_column('system_config', sa.Column('config_type', sa.String(length=32), nullable=True, comment='配置类型（string/number/boolean/json）'))
    op.add_column('system_config', sa.Column('is_public', sa.Boolean(), nullable=True, comment='是否前端可见'))
    op.alter_column('system_config', 'config_key',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='配置键',
               existing_comment='配置键（如anonymous_mode、data_visibility）',
               existing_nullable=False)
    op.alter_column('system_config', 'operator_id',
               existing_type=mysql.BIGINT(),
               nullable=True,
               comment='操作人ID',
               existing_comment='操作人ID（学校管理员）')
    op.drop_index('config_key', table_name='system_config')
    op.create_index(op.f('ix_system_config_config_key'), 'system_config', ['config_key'], unique=True)
    op.create_index(op.f('ix_system_config_operator_id'), 'system_config', ['operator_id'], unique=False)
    op.drop_constraint('system_config_ibfk_1', 'system_config', type_='foreignkey')
    op.create_foreign_key(None, 'system_config', 'user', ['operator_id'], ['id'], ondelete='SET NULL')
    op.create_table_comment(
        'system_config',
        '系统配置表',
        existing_comment=None,
        schema=None
    )
    op.add_column('teacher_evaluation_stat', sa.Column('max_score', mysql.TINYINT(), nullable=True, comment='最高分'))
    op.add_column('teacher_evaluation_stat', sa.Column('min_score', mysql.TINYINT(), nullable=True, comment='最低分'))
    op.add_column('teacher_evaluation_stat', sa.Column('school_total', sa.SmallInteger(), nullable=True, comment='全校参评教师总数'))
    op.add_column('teacher_evaluation_stat', sa.Column('college_total', sa.SmallInteger(), nullable=True, comment='院内参评教师总数'))
    op.add_column('teacher_evaluation_stat', sa.Column('score_distribution', sa.JSON(), nullable=True, comment='分数分布（优秀/良好/合格/不合格数量）'))
    op.alter_column('teacher_evaluation_stat', 'stat_year',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=4),
               comment='统计学年（如2024-2025）',
               existing_comment='统计年份',
               existing_nullable=False)
    op.create_index('idx_teacher_stat_college', 'teacher_evaluation_stat', ['college_id', 'stat_year', 'stat_semester'], unique=False)
    op.create_index('idx_teacher_stat_year_semester', 'teacher_evaluation_stat', ['stat_year', 'stat_semester'], unique=False)
    op.create_index(op.f('ix_teacher_evaluation_stat_college_id'), 'teacher_evaluation_stat', ['college_id'], unique=False)
    op.create_index(op.f('ix_teacher_evaluation_stat_stat_year'), 'teacher_evaluation_stat', ['stat_year'], unique=False)
    op.create_index(op.f('ix_teacher_evaluation_stat_teacher_id'), 'teacher_evaluation_stat', ['teacher_id'], unique=False)
    op.create_unique_constraint('uk_teacher_stat_period', 'teacher_evaluation_stat', ['teacher_id', 'stat_year', 'stat_semester'])
    op.drop_constraint('teacher_evaluation_stat_ibfk_2', 'teacher_evaluation_stat', type_='foreignkey')
    op.drop_constraint('teacher_evaluation_stat_ibfk_1', 'teacher_evaluation_stat', type_='foreignkey')
    op.create_foreign_key(None, 'teacher_evaluation_stat', 'user', ['teacher_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'teacher_evaluation_stat', 'college', ['college_id'], ['id'], ondelete='CASCADE')
    op.create_table_comment(
        'teacher_evaluation_stat',
        '教师评价统计表',
        existing_comment=None,
        schema=None
    )
    op.add_column('teaching_evaluation', sa.Column('score_level', sa.String(length=8), nullable=True, comment='等级（优秀/良好/合格/不合格）'))
    op.add_column('teaching_evaluation', sa.Column('listen_date', sa.DateTime(), nullable=False, comment='实际听课日期'))
    op.add_column('teaching_evaluation', sa.Column('listen_duration', sa.SmallInteger(), nullable=True, comment='听课时长（分钟）'))
    op.add_column('teaching_evaluation', sa.Column('listen_location', sa.String(length=64), nullable=True, comment='实际听课地点'))
    op.add_column('teaching_evaluation', sa.Column('status', mysql.TINYINT(), nullable=True, comment='状态 1-有效 0-作废 2-待审核'))
    op.alter_column('teaching_evaluation', 'evaluation_no',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='评教编号',
               existing_comment='评教编号（学院编码+年份+随机数）',
               existing_nullable=False)
    op.alter_column('teaching_evaluation', 'dimension_scores',
               existing_type=mysql.JSON(),
               comment='各维度得分',
               existing_comment='各维度得分（如{"课程导入":20,"互动性":15}）',
               existing_nullable=False)
    op.alter_column('teaching_evaluation', 'is_anonymous',
               existing_type=mysql.TINYINT(display_width=1),
               comment='是否匿名',
               existing_comment='是否匿名 0-实名 1-匿名',
               existing_nullable=True)
    op.alter_column('teaching_evaluation', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除',
               existing_comment='逻辑删除 0-正常 1-删除',
               existing_nullable=True)
    op.drop_index('evaluation_no', table_name='teaching_evaluation')
    op.create_index('idx_evaluation_listen_date', 'teaching_evaluation', ['listen_date', 'status'], unique=False)
    op.create_index('idx_evaluation_score_level', 'teaching_evaluation', ['score_level', 'status'], unique=False)
    op.create_index('idx_evaluation_submit', 'teaching_evaluation', ['submit_time', 'is_delete'], unique=False)
    op.create_index('idx_evaluation_teachers', 'teaching_evaluation', ['teach_teacher_id', 'listen_teacher_id'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_evaluation_no'), 'teaching_evaluation', ['evaluation_no'], unique=True)
    op.create_index(op.f('ix_teaching_evaluation_is_delete'), 'teaching_evaluation', ['is_delete'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_listen_date'), 'teaching_evaluation', ['listen_date'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_listen_teacher_id'), 'teaching_evaluation', ['listen_teacher_id'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_score_level'), 'teaching_evaluation', ['score_level'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_status'), 'teaching_evaluation', ['status'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_submit_time'), 'teaching_evaluation', ['submit_time'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_teach_teacher_id'), 'teaching_evaluation', ['teach_teacher_id'], unique=False)
    op.create_index(op.f('ix_teaching_evaluation_timetable_id'), 'teaching_evaluation', ['timetable_id'], unique=False)
    op.create_unique_constraint('uk_evaluation_unique', 'teaching_evaluation', ['timetable_id', 'listen_teacher_id', 'listen_date'])
    op.create_table_comment(
        'teaching_evaluation',
        '教学评价表',
        existing_comment=None,
        schema=None
    )
    op.add_column('timetable', sa.Column('course_code', sa.String(length=32), nullable=True, comment='课程编码'))
    op.add_column('timetable', sa.Column('student_count', sa.SmallInteger(), nullable=True, comment='学生人数'))
    op.add_column('timetable', sa.Column('credit', sa.DECIMAL(precision=3, scale=1), nullable=True, comment='学分'))
    op.add_column('timetable', sa.Column('academic_year', sa.String(length=9), nullable=False, comment='学年（如2024-2025）'))
    op.add_column('timetable', sa.Column('semester', mysql.TINYINT(), nullable=False, comment='学期 1-春季 2-秋季'))
    op.add_column('timetable', sa.Column('teach_week_start', mysql.TINYINT(), nullable=True, comment='起始周次'))
    op.add_column('timetable', sa.Column('teach_week_end', mysql.TINYINT(), nullable=True, comment='结束周次'))
    op.add_column('timetable', sa.Column('weekday', mysql.TINYINT(), nullable=True, comment='星期几 1-7'))
    op.add_column('timetable', sa.Column('period_start', mysql.TINYINT(), nullable=True, comment='开始节次'))
    op.add_column('timetable', sa.Column('period_end', mysql.TINYINT(), nullable=True, comment='结束节次'))
    op.add_column('timetable', sa.Column('sync_status', mysql.TINYINT(), nullable=True, comment='同步状态 1-成功 0-失败'))
    op.alter_column('timetable', 'timetable_no',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='课表编号',
               existing_comment='课表编号（教务系统同步）',
               existing_nullable=False)
    op.alter_column('timetable', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除',
               existing_comment='逻辑删除 0-正常 1-删除',
               existing_nullable=True)
    op.drop_index('timetable_no', table_name='timetable')
    op.create_index('idx_timetable_college_teacher', 'timetable', ['college_id', 'teacher_id'], unique=False)
    op.create_index('idx_timetable_course', 'timetable', ['course_code', 'course_name'], unique=False)
    op.create_index('idx_timetable_schedule', 'timetable', ['weekday', 'period_start'], unique=False)
    op.create_index('idx_timetable_year_semester', 'timetable', ['academic_year', 'semester'], unique=False)
    op.create_index(op.f('ix_timetable_academic_year'), 'timetable', ['academic_year'], unique=False)
    op.create_index(op.f('ix_timetable_college_id'), 'timetable', ['college_id'], unique=False)
    op.create_index(op.f('ix_timetable_course_code'), 'timetable', ['course_code'], unique=False)
    op.create_index(op.f('ix_timetable_course_name'), 'timetable', ['course_name'], unique=False)
    op.create_index(op.f('ix_timetable_course_type'), 'timetable', ['course_type'], unique=False)
    op.create_index(op.f('ix_timetable_is_delete'), 'timetable', ['is_delete'], unique=False)
    op.create_index(op.f('ix_timetable_semester'), 'timetable', ['semester'], unique=False)
    op.create_index(op.f('ix_timetable_teacher_id'), 'timetable', ['teacher_id'], unique=False)
    op.create_index(op.f('ix_timetable_timetable_no'), 'timetable', ['timetable_no'], unique=True)
    op.create_table_comment(
        'timetable',
        '课表',
        existing_comment=None,
        schema=None
    )
    op.add_column('user', sa.Column('token_expire_time', sa.DateTime(), nullable=True, comment='token过期时间'))
    op.add_column('user', sa.Column('last_login_time', sa.DateTime(), nullable=True, comment='最近登录时间'))
    op.add_column('user', sa.Column('login_fail_count', mysql.TINYINT(), nullable=True, comment='连续登录失败次数'))
    op.add_column('user', sa.Column('lock_until', sa.DateTime(), nullable=True, comment='锁定截止时间'))
    op.alter_column('user', 'password',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=128),
               comment='密码（bcrypt加密）',
               existing_comment='密码（加密存储）',
               existing_nullable=False)
    op.alter_column('user', 'last_login_ip',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='最近登录IP（支持IPv6）',
               existing_comment='最近登录IP',
               existing_nullable=True)
    op.drop_index('user_id', table_name='user')
    op.create_index('idx_user_status_delete', 'user', ['status', 'is_delete'], unique=False)
    op.create_index('idx_user_token', 'user', ['token'], unique=False)
    op.create_index(op.f('ix_user_college_id'), 'user', ['college_id'], unique=False)
    op.create_index(op.f('ix_user_is_delete'), 'user', ['is_delete'], unique=False)
    op.create_index(op.f('ix_user_status'), 'user', ['status'], unique=False)
    op.create_index(op.f('ix_user_user_id'), 'user', ['user_id'], unique=True)
    op.drop_constraint('user_ibfk_1', 'user', type_='foreignkey')
    op.create_foreign_key(None, 'user', 'college', ['college_id'], ['id'], ondelete='SET NULL')
    op.create_table_comment(
        'user',
        '用户表',
        existing_comment=None,
        schema=None
    )
    op.drop_column('user', 'wx_openid')
    op.drop_column('user', 'wx_session_key')
    op.create_index(op.f('ix_user_role_role_id'), 'user_role', ['role_id'], unique=False)
    op.create_index(op.f('ix_user_role_user_id'), 'user_role', ['user_id'], unique=False)
    op.drop_constraint('user_role_ibfk_1', 'user_role', type_='foreignkey')
    op.drop_constraint('user_role_ibfk_2', 'user_role', type_='foreignkey')
    op.create_foreign_key(None, 'user_role', 'role', ['role_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'user_role', 'user', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_table_comment(
        'user_role',
        '用户角色关联表',
        existing_comment=None,
        schema=None
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table_comment(
        'user_role',
        existing_comment='用户角色关联表',
        schema=None
    )
    op.drop_constraint(None, 'user_role', type_='foreignkey')
    op.drop_constraint(None, 'user_role', type_='foreignkey')
    op.create_foreign_key('user_role_ibfk_2', 'user_role', 'user', ['user_id'], ['id'])
    op.create_foreign_key('user_role_ibfk_1', 'user_role', 'role', ['role_id'], ['id'])
    op.drop_index(op.f('ix_user_role_user_id'), table_name='user_role')
    op.drop_index(op.f('ix_user_role_role_id'), table_name='user_role')
    op.add_column('user', sa.Column('wx_session_key', mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64), nullable=True, comment='用户session_key'))
    op.add_column('user', sa.Column('wx_openid', mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64), nullable=True, comment='微信openid'))
    op.drop_table_comment(
        'user',
        existing_comment='用户表',
        schema=None
    )
    op.drop_constraint(None, 'user', type_='foreignkey')
    op.create_foreign_key('user_ibfk_1', 'user', 'college', ['college_id'], ['id'])
    op.drop_index(op.f('ix_user_user_id'), table_name='user')
    op.drop_index(op.f('ix_user_status'), table_name='user')
    op.drop_index(op.f('ix_user_is_delete'), table_name='user')
    op.drop_index(op.f('ix_user_college_id'), table_name='user')
    op.drop_index('idx_user_token', table_name='user')
    op.drop_index('idx_user_status_delete', table_name='user')
    op.create_index('user_id', 'user', ['user_id'], unique=False)
    op.alter_column('user', 'last_login_ip',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='最近登录IP',
               existing_comment='最近登录IP（支持IPv6）',
               existing_nullable=True)
    op.alter_column('user', 'password',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=128),
               comment='密码（加密存储）',
               existing_comment='密码（bcrypt加密）',
               existing_nullable=False)
    op.drop_column('user', 'lock_until')
    op.drop_column('user', 'login_fail_count')
    op.drop_column('user', 'last_login_time')
    op.drop_column('user', 'token_expire_time')
    op.drop_table_comment(
        'timetable',
        existing_comment='课表',
        schema=None
    )
    op.drop_index(op.f('ix_timetable_timetable_no'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_teacher_id'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_semester'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_is_delete'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_course_type'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_course_name'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_course_code'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_college_id'), table_name='timetable')
    op.drop_index(op.f('ix_timetable_academic_year'), table_name='timetable')
    op.drop_index('idx_timetable_year_semester', table_name='timetable')
    op.drop_index('idx_timetable_schedule', table_name='timetable')
    op.drop_index('idx_timetable_course', table_name='timetable')
    op.drop_index('idx_timetable_college_teacher', table_name='timetable')
    op.create_index('timetable_no', 'timetable', ['timetable_no'], unique=False)
    op.alter_column('timetable', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除 0-正常 1-删除',
               existing_comment='逻辑删除',
               existing_nullable=True)
    op.alter_column('timetable', 'timetable_no',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='课表编号（教务系统同步）',
               existing_comment='课表编号',
               existing_nullable=False)
    op.drop_column('timetable', 'sync_status')
    op.drop_column('timetable', 'period_end')
    op.drop_column('timetable', 'period_start')
    op.drop_column('timetable', 'weekday')
    op.drop_column('timetable', 'teach_week_end')
    op.drop_column('timetable', 'teach_week_start')
    op.drop_column('timetable', 'semester')
    op.drop_column('timetable', 'academic_year')
    op.drop_column('timetable', 'credit')
    op.drop_column('timetable', 'student_count')
    op.drop_column('timetable', 'course_code')
    op.drop_table_comment(
        'teaching_evaluation',
        existing_comment='教学评价表',
        schema=None
    )
    op.drop_constraint('uk_evaluation_unique', 'teaching_evaluation', type_='unique')
    op.drop_index(op.f('ix_teaching_evaluation_timetable_id'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_teach_teacher_id'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_submit_time'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_status'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_score_level'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_listen_teacher_id'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_listen_date'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_is_delete'), table_name='teaching_evaluation')
    op.drop_index(op.f('ix_teaching_evaluation_evaluation_no'), table_name='teaching_evaluation')
    op.drop_index('idx_evaluation_teachers', table_name='teaching_evaluation')
    op.drop_index('idx_evaluation_submit', table_name='teaching_evaluation')
    op.drop_index('idx_evaluation_score_level', table_name='teaching_evaluation')
    op.drop_index('idx_evaluation_listen_date', table_name='teaching_evaluation')
    op.create_index('evaluation_no', 'teaching_evaluation', ['evaluation_no'], unique=False)
    op.alter_column('teaching_evaluation', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除 0-正常 1-删除',
               existing_comment='逻辑删除',
               existing_nullable=True)
    op.alter_column('teaching_evaluation', 'is_anonymous',
               existing_type=mysql.TINYINT(display_width=1),
               comment='是否匿名 0-实名 1-匿名',
               existing_comment='是否匿名',
               existing_nullable=True)
    op.alter_column('teaching_evaluation', 'dimension_scores',
               existing_type=mysql.JSON(),
               comment='各维度得分（如{"课程导入":20,"互动性":15}）',
               existing_comment='各维度得分',
               existing_nullable=False)
    op.alter_column('teaching_evaluation', 'evaluation_no',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='评教编号（学院编码+年份+随机数）',
               existing_comment='评教编号',
               existing_nullable=False)
    op.drop_column('teaching_evaluation', 'status')
    op.drop_column('teaching_evaluation', 'listen_location')
    op.drop_column('teaching_evaluation', 'listen_duration')
    op.drop_column('teaching_evaluation', 'listen_date')
    op.drop_column('teaching_evaluation', 'score_level')
    op.drop_table_comment(
        'teacher_evaluation_stat',
        existing_comment='教师评价统计表',
        schema=None
    )
    op.drop_constraint(None, 'teacher_evaluation_stat', type_='foreignkey')
    op.drop_constraint(None, 'teacher_evaluation_stat', type_='foreignkey')
    op.create_foreign_key('teacher_evaluation_stat_ibfk_1', 'teacher_evaluation_stat', 'college', ['college_id'], ['id'])
    op.create_foreign_key('teacher_evaluation_stat_ibfk_2', 'teacher_evaluation_stat', 'user', ['teacher_id'], ['id'])
    op.drop_constraint('uk_teacher_stat_period', 'teacher_evaluation_stat', type_='unique')
    op.drop_index(op.f('ix_teacher_evaluation_stat_teacher_id'), table_name='teacher_evaluation_stat')
    op.drop_index(op.f('ix_teacher_evaluation_stat_stat_year'), table_name='teacher_evaluation_stat')
    op.drop_index(op.f('ix_teacher_evaluation_stat_college_id'), table_name='teacher_evaluation_stat')
    op.drop_index('idx_teacher_stat_year_semester', table_name='teacher_evaluation_stat')
    op.drop_index('idx_teacher_stat_college', table_name='teacher_evaluation_stat')
    op.alter_column('teacher_evaluation_stat', 'stat_year',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=4),
               comment='统计年份',
               existing_comment='统计学年（如2024-2025）',
               existing_nullable=False)
    op.drop_column('teacher_evaluation_stat', 'score_distribution')
    op.drop_column('teacher_evaluation_stat', 'college_total')
    op.drop_column('teacher_evaluation_stat', 'school_total')
    op.drop_column('teacher_evaluation_stat', 'min_score')
    op.drop_column('teacher_evaluation_stat', 'max_score')
    op.drop_table_comment(
        'system_config',
        existing_comment='系统配置表',
        schema=None
    )
    op.drop_constraint(None, 'system_config', type_='foreignkey')
    op.create_foreign_key('system_config_ibfk_1', 'system_config', 'user', ['operator_id'], ['id'])
    op.drop_index(op.f('ix_system_config_operator_id'), table_name='system_config')
    op.drop_index(op.f('ix_system_config_config_key'), table_name='system_config')
    op.create_index('config_key', 'system_config', ['config_key'], unique=False)
    op.alter_column('system_config', 'operator_id',
               existing_type=mysql.BIGINT(),
               nullable=False,
               comment='操作人ID（学校管理员）',
               existing_comment='操作人ID')
    op.alter_column('system_config', 'config_key',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=64),
               comment='配置键（如anonymous_mode、data_visibility）',
               existing_comment='配置键',
               existing_nullable=False)
    op.drop_column('system_config', 'is_public')
    op.drop_column('system_config', 'config_type')
    op.drop_table_comment(
        'role_permission',
        existing_comment='角色权限关联表',
        schema=None
    )
    op.drop_constraint(None, 'role_permission', type_='foreignkey')
    op.drop_constraint(None, 'role_permission', type_='foreignkey')
    op.create_foreign_key('role_permission_ibfk_2', 'role_permission', 'role', ['role_id'], ['id'])
    op.create_foreign_key('role_permission_ibfk_1', 'role_permission', 'permission', ['permission_id'], ['id'])
    op.drop_index(op.f('ix_role_permission_role_id'), table_name='role_permission')
    op.drop_index(op.f('ix_role_permission_permission_id'), table_name='role_permission')
    op.drop_table_comment(
        'role',
        existing_comment='角色表',
        schema=None
    )
    op.drop_index(op.f('ix_role_status'), table_name='role')
    op.drop_index(op.f('ix_role_role_code'), table_name='role')
    op.drop_index(op.f('ix_role_is_delete'), table_name='role')
    op.drop_index('idx_role_status_delete', table_name='role')
    op.create_index('role_code', 'role', ['role_code'], unique=False)
    op.drop_column('role', 'role_level')
    op.drop_table_comment(
        'permission',
        existing_comment='权限表',
        schema=None
    )
    op.drop_constraint(None, 'permission', type_='foreignkey')
    op.drop_index(op.f('ix_permission_permission_type'), table_name='permission')
    op.drop_index(op.f('ix_permission_permission_code'), table_name='permission')
    op.drop_index(op.f('ix_permission_parent_id'), table_name='permission')
    op.drop_index(op.f('ix_permission_is_delete'), table_name='permission')
    op.drop_index('idx_permission_type_order', table_name='permission')
    op.create_index('permission_code', 'permission', ['permission_code'], unique=False)
    op.drop_column('permission', 'sort_order')
    op.drop_column('permission', 'parent_id')
    op.drop_table_comment(
        'college_evaluation_stat',
        existing_comment='学院评价统计表',
        schema=None
    )
    op.drop_constraint(None, 'college_evaluation_stat', type_='foreignkey')
    op.create_foreign_key('college_evaluation_stat_ibfk_1', 'college_evaluation_stat', 'college', ['college_id'], ['id'])
    op.drop_constraint('uk_college_stat_period', 'college_evaluation_stat', type_='unique')
    op.drop_index(op.f('ix_college_evaluation_stat_stat_year'), table_name='college_evaluation_stat')
    op.drop_index(op.f('ix_college_evaluation_stat_college_id'), table_name='college_evaluation_stat')
    op.drop_index('idx_college_stat_year_semester', table_name='college_evaluation_stat')
    op.alter_column('college_evaluation_stat', 'stat_year',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=4),
               comment='统计年份',
               existing_comment='统计学年',
               existing_nullable=False)
    op.drop_column('college_evaluation_stat', 'last_export_time')
    op.drop_column('college_evaluation_stat', 'excellent_rate')
    op.drop_column('college_evaluation_stat', 'score_distribution')
    op.drop_column('college_evaluation_stat', 'school_total')
    op.drop_column('college_evaluation_stat', 'total_evaluation_num')
    op.drop_table_comment(
        'college',
        existing_comment='学院表',
        schema=None
    )
    op.drop_index(op.f('ix_college_is_delete'), table_name='college')
    op.drop_index(op.f('ix_college_college_code'), table_name='college')
    op.create_index('college_code', 'college', ['college_code'], unique=False)
    op.alter_column('college', 'is_delete',
               existing_type=mysql.TINYINT(display_width=1),
               comment='逻辑删除 0-正常 1-删除',
               existing_comment='逻辑删除',
               existing_nullable=True)
    op.alter_column('college', 'college_code',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=32),
               comment='学院编码（如01：信息工程学院）',
               existing_comment='学院编码',
               existing_nullable=False)
    op.drop_column('college', 'sort_order')
    op.drop_column('college', 'short_name')
    op.drop_index(op.f('ix_user_wechat_bind_unionid'), table_name='user_wechat_bind')
    op.drop_index(op.f('ix_user_wechat_bind_openid'), table_name='user_wechat_bind')
    op.drop_table('user_wechat_bind')
    op.drop_index(op.f('ix_operation_log_user_id'), table_name='operation_log')
    op.drop_index(op.f('ix_operation_log_operation_type'), table_name='operation_log')
    op.drop_index(op.f('ix_operation_log_module'), table_name='operation_log')
    op.drop_index(op.f('ix_operation_log_create_time'), table_name='operation_log')
    op.drop_index(op.f('ix_operation_log_create_date'), table_name='operation_log')
    op.drop_index('idx_log_user_time', table_name='operation_log')
    op.drop_index('idx_log_target', table_name='operation_log')
    op.drop_index('idx_log_module_type', table_name='operation_log')
    op.drop_index('idx_log_date', table_name='operation_log')
    op.drop_table('operation_log')
    op.drop_index(op.f('ix_login_log_user_id'), table_name='login_log')
    op.drop_index(op.f('ix_login_log_create_time'), table_name='login_log')
    op.drop_index(op.f('ix_login_log_create_date'), table_name='login_log')
    op.drop_index('idx_login_user_time', table_name='login_log')
    op.drop_index('idx_login_status_time', table_name='login_log')
    op.drop_index('idx_login_date', table_name='login_log')
    op.drop_table('login_log')
    op.drop_index(op.f('ix_operation_log_archive_create_time'), table_name='operation_log_archive')
    op.drop_index(op.f('ix_operation_log_archive_create_date'), table_name='operation_log_archive')
    op.drop_index('idx_archive_user', table_name='operation_log_archive')
    op.drop_index('idx_archive_date', table_name='operation_log_archive')
    op.drop_table('operation_log_archive')
    op.drop_index(op.f('ix_login_log_archive_create_time'), table_name='login_log_archive')
    op.drop_index(op.f('ix_login_log_archive_create_date'), table_name='login_log_archive')
    op.drop_index('idx_login_archive_date', table_name='login_log_archive')
    op.drop_table('login_log_archive')
    op.drop_index(op.f('ix_evaluation_dimension_is_delete'), table_name='evaluation_dimension')
    op.drop_index(op.f('ix_evaluation_dimension_dimension_code'), table_name='evaluation_dimension')
    op.drop_index('idx_dimension_status_order', table_name='evaluation_dimension')
    op.drop_table('evaluation_dimension')
    # ### end Alembic commands ###
