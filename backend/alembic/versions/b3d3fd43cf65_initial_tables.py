"""initial tables

Revision ID: b3d3fd43cf65
Revises: 
Create Date: 2025-12-24 19:33:43.580355

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'b3d3fd43cf65'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('college',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='学院ID'),
    sa.Column('college_code', sa.String(length=32), nullable=False, comment='学院编码（如01：信息工程学院）'),
    sa.Column('college_name', sa.String(length=64), nullable=False, comment='学院名称'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('update_time', sa.DateTime(), nullable=True, comment='更新时间'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('college_code')
    )
    op.create_table('permission_dict',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='权限ID'),
    sa.Column('permission_code', sa.String(length=64), nullable=False, comment='权限编码（唯一）'),
    sa.Column('permission_name', sa.String(length=128), nullable=False, comment='权限名称'),
    sa.Column('permission_type', sa.Integer(), nullable=False, comment='权限类型 1-数据查看 2-操作管理 3-报表导出 4-系统配置'),
    sa.Column('parent_id', sa.BigInteger(), nullable=True, comment='父权限ID（0=顶级权限）'),
    sa.Column('sort', sa.Integer(), nullable=True, comment='排序值'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('permission_code')
    )
    op.create_table('college_evaluation_stat',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='统计记录ID'),
    sa.Column('college_id', sa.BigInteger(), nullable=False, comment='学院ID'),
    sa.Column('stat_year', sa.String(length=4), nullable=False, comment='统计年份'),
    sa.Column('stat_semester', sa.Integer(), nullable=False, comment='统计学期 1-春季 2-秋季'),
    sa.Column('total_teacher_num', sa.Integer(), nullable=True, comment='参评教师总数'),
    sa.Column('avg_total_score', sa.DECIMAL(precision=5, scale=2), nullable=True, comment='学院总平均分'),
    sa.Column('dimension_avg_scores', sa.JSON(), nullable=True, comment='学院各维度平均分'),
    sa.Column('school_rank', sa.Integer(), nullable=True, comment='学院全校排名'),
    sa.Column('high_freq_problems', sa.JSON(), nullable=True, comment='学院高频问题'),
    sa.Column('report_export_num', sa.Integer(), nullable=True, comment='报表导出次数'),
    sa.Column('update_time', sa.DateTime(), nullable=True, comment='更新时间'),
    sa.ForeignKeyConstraint(['college_id'], ['college.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('user',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='用户ID'),
    sa.Column('user_no', sa.String(length=32), nullable=False, comment='工号/账号'),
    sa.Column('user_name', sa.String(length=64), nullable=False, comment='用户名'),
    sa.Column('role_type', sa.Integer(), nullable=False, comment='角色类型 1-普通教师 2-督导 3-学院管理员 4-学校管理员'),
    sa.Column('college_id', sa.BigInteger(), nullable=False, comment='所属学院ID'),
    sa.Column('password', sa.String(length=128), nullable=False, comment='密码（加密存储）'),
    sa.Column('token', sa.String(length=256), nullable=True, comment='登录令牌'),
    sa.Column('token_expire_time', sa.DateTime(), nullable=True, comment='令牌过期时间'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('update_time', sa.DateTime(), nullable=True, comment='更新时间'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.ForeignKeyConstraint(['college_id'], ['college.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_no')
    )
    op.create_table('system_config',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='配置ID'),
    sa.Column('config_key', sa.String(length=64), nullable=False, comment='配置键（如anonymous_mode、data_visibility）'),
    sa.Column('config_value', sa.JSON(), nullable=False, comment='配置值'),
    sa.Column('config_desc', sa.String(length=256), nullable=False, comment='配置描述'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('update_time', sa.DateTime(), nullable=True, comment='更新时间'),
    sa.Column('operator_id', sa.BigInteger(), nullable=False, comment='操作人ID（学校管理员）'),
    sa.ForeignKeyConstraint(['operator_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('config_key')
    )
    op.create_table('teacher_evaluation_stat',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='统计记录ID'),
    sa.Column('teacher_id', sa.BigInteger(), nullable=False, comment='教师ID'),
    sa.Column('college_id', sa.BigInteger(), nullable=False, comment='所属学院ID'),
    sa.Column('stat_year', sa.String(length=4), nullable=False, comment='统计年份'),
    sa.Column('stat_semester', sa.Integer(), nullable=False, comment='统计学期 1-春季 2-秋季'),
    sa.Column('total_evaluation_num', sa.Integer(), nullable=True, comment='评教总次数'),
    sa.Column('avg_total_score', sa.DECIMAL(precision=5, scale=2), nullable=True, comment='总分平均分'),
    sa.Column('dimension_avg_scores', sa.JSON(), nullable=True, comment='各维度平均分'),
    sa.Column('school_rank', sa.Integer(), nullable=True, comment='全校排名'),
    sa.Column('college_rank', sa.Integer(), nullable=True, comment='院内排名'),
    sa.Column('high_freq_problems', sa.JSON(), nullable=True, comment='高频问题'),
    sa.Column('high_freq_suggestions', sa.JSON(), nullable=True, comment='高频建议'),
    sa.Column('update_time', sa.DateTime(), nullable=True, comment='更新时间'),
    sa.ForeignKeyConstraint(['college_id'], ['college.id'], ),
    sa.ForeignKeyConstraint(['teacher_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('timetable',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='课表记录ID'),
    sa.Column('timetable_no', sa.String(length=64), nullable=False, comment='课表编号（教务系统同步）'),
    sa.Column('college_id', sa.BigInteger(), nullable=False, comment='所属学院ID'),
    sa.Column('teacher_id', sa.BigInteger(), nullable=False, comment='授课教师ID'),
    sa.Column('course_name', sa.String(length=128), nullable=False, comment='课程名称'),
    sa.Column('course_type', sa.String(length=32), nullable=False, comment='课程类型（必修课/选修课/实训课）'),
    sa.Column('class_name', sa.String(length=64), nullable=False, comment='授课班级'),
    sa.Column('teach_week', sa.String(length=64), nullable=False, comment='授课周次（如1-16周）'),
    sa.Column('teach_time', sa.String(length=64), nullable=False, comment='授课时间（如周一第3-4节）'),
    sa.Column('teach_place', sa.String(length=64), nullable=False, comment='授课地点'),
    sa.Column('sync_time', sa.DateTime(), nullable=False, comment='最后同步时间'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('update_time', sa.DateTime(), nullable=True, comment='更新时间'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.ForeignKeyConstraint(['college_id'], ['college.id'], ),
    sa.ForeignKeyConstraint(['teacher_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('timetable_no')
    )
    op.create_table('user_permission',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='关联ID'),
    sa.Column('user_id', sa.BigInteger(), nullable=False, comment='用户ID'),
    sa.Column('permission_id', sa.BigInteger(), nullable=False, comment='权限ID（关联permission_dict）'),
    sa.Column('scope_college_ids', sa.JSON(), nullable=True, comment='权限生效范围（如["1","2"]=仅1/2学院生效）'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='绑定时间'),
    sa.Column('operator_id', sa.BigInteger(), nullable=False, comment='授权人ID（学校管理员）'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.ForeignKeyConstraint(['operator_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['permission_id'], ['permission_dict.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('teaching_evaluation',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False, comment='评教记录ID'),
    sa.Column('evaluation_no', sa.String(length=64), nullable=False, comment='评教编号（学院编码+年份+随机数）'),
    sa.Column('timetable_id', sa.BigInteger(), nullable=False, comment='关联课表ID'),
    sa.Column('teach_teacher_id', sa.BigInteger(), nullable=False, comment='授课教师ID'),
    sa.Column('listen_teacher_id', sa.BigInteger(), nullable=False, comment='听课教师ID'),
    sa.Column('total_score', sa.Integer(), nullable=False, comment='评教总分（0-100）'),
    sa.Column('dimension_scores', sa.JSON(), nullable=False, comment='各维度得分（如{"课程导入":20,"互动性":15}）'),
    sa.Column('advantage_content', sa.Text(), nullable=True, comment='优点描述'),
    sa.Column('problem_content', sa.Text(), nullable=True, comment='问题描述'),
    sa.Column('improve_suggestion', sa.Text(), nullable=True, comment='改进建议'),
    sa.Column('is_anonymous', sa.Boolean(), nullable=True, comment='是否匿名 0-实名 1-匿名'),
    sa.Column('submit_time', sa.DateTime(), nullable=False, comment='提交时间'),
    sa.Column('create_time', sa.DateTime(), nullable=True, comment='创建时间'),
    sa.Column('update_time', sa.DateTime(), nullable=True, comment='更新时间'),
    sa.Column('is_delete', sa.Boolean(), nullable=True, comment='逻辑删除 0-正常 1-删除'),
    sa.ForeignKeyConstraint(['listen_teacher_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['teach_teacher_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['timetable_id'], ['timetable.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('evaluation_no')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('teaching_evaluation')
    op.drop_table('user_permission')
    op.drop_table('timetable')
    op.drop_table('teacher_evaluation_stat')
    op.drop_table('system_config')
    op.drop_table('user')
    op.drop_table('college_evaluation_stat')
    op.drop_table('permission_dict')
    op.drop_table('college')
    # ### end Alembic commands ###
